---
#title: "Infracom interview task - hospital estate condition"
#author: "Leon Stirk-Wang"
#date: "`r Sys.Date()`"
output: 
  pdf_document:   # or pdf_document / word_document
    latex_engine: xelatex
---

```{r include=FALSE}
## Libraries
library(tidyverse)
library(viridis)
library(emoa) # Pareto dominance calculation
library(rlang)
library(huxtable)

options(
  huxtable.knit_print_df = FALSE,  # don't auto-convert data frames
  huxtable.latex = TRUE,           # enable LaTeX when knitting to PDF
  huxtable.booktabs = TRUE
)

```

```{r include=FALSE}
## Load clean data
hosp <- readRDS('data/hosp_clean.rds')
```

# Hospital Building Condition and Seismic Vulnerability

This note assesses the condition and earthquake vulnerability of New Zealand’s hospital buildings using only the dataset provided. The variables available relate mainly to building condition, seismic performance (%NBS, seismic zone, importance level), and gross floor area. The analysis has therefore been framed as a data-limited sandbox exercise focusing on renewal and maintenance needs rather than broader capital planning.

There are two objectives:

- Identify high-need buildings by jointly considering condition and earthquake risk, using a transparent non-weighted Pareto prioritisation method.

- Highlight key data gaps that materially affect investment decisions, particularly for high-importance (IL4) buildings.

## Data Overview and Limitations

The dataset contains 1245 buildings across multiple regions, with key fields on condition, seismic performance, and gross floor area. Several variables required cleaning to standardise placeholders such as “-”, “NO DATA”, and “Nil” into missing values.

Missing data is material for decision-making: 48 IL4 buildings lack %NBS and/or condition data, and some fields are incomplete. These gaps reduce confidence in prioritisation and indicate the need for targeted assessments prior to, or as a part of, any investment programme.

```{r echo=FALSE}
# Inputs
vars       <- c("condition", "gfa", "nbs", "seismic_il", "seismic_zone")
nice_names <- c("Condition", "Gross Floor Area", "% NBS", "Seismic Importance", "Seismic Zone")

# Named vectors: counts & percents
na_n <- setNames(sapply(hosp[vars], \(x) sum(is.na(x))), nice_names)
na_p <- setNames(na_n / nrow(hosp) * 100,                 nice_names)

# Create wide matrix: 2 rows (n, %) × variables as columns
df_wide <- rbind(
  "Variable"   = nice_names,
  "Missing (n)" = as.integer(na_n)
  #"Missing (%)" = sprintf("%.1f", na_p)  # keep as char so we can append % below
)

# Add % symbol to the second row
# df_wide[3, ] <- paste0(df_wide[3, ], "%")

# Convert to huxtable
ht <- hux(as.data.frame(df_wide), add_colnames = FALSE) %>%
  add_rownames("Measure") %>%
  set_escape_contents(everywhere, everywhere, TRUE) %>%
  set_lr_padding(everywhere, everywhere, 2) %>%
  set_top_padding(everywhere, everywhere, 1) %>% 
  set_bottom_padding(everywhere, everywhere, 4)

# Styling
top_border(ht)[1, ]              <- brdr(1, style = "double")
bottom_border(ht)[c(1, nrow(ht)),] <- 1
bold(ht)[1, ]                    <- TRUE
valign(ht)                       <- "middle"
position(ht)                     <- "center"
align(ht)                        <- "center"
width(ht)                        <- 1   # a bit wider for wide format
col_width(ht)                    <- c(rep(1/6, length(nice_names)+1))

caption(ht) <- "Missing data summary for key variables"
caption_pos(ht) <- "bottom"   # or "bottom"

ht

```

```{r include=FALSE, eval=FALSE}

tmp <- hosp %>% 
  filter(seismic_il == "IL4" & (is.na(condition) | is.na(nbs))) %>% 
  arrange(desc(seismic_zone), nbs, desc(condition)) %>% 
  mutate(seismic_zone = str_replace(seismic_zone, ' Zone', '')) %>% 
  select(#region, 
         #dhb_name, 
         campus_name, 
         building_name, 
         seismic_il, 
         seismic_zone, 
         graded_nbs, 
         condition_grade, 
         gfa) %>% .[c(1,3,13,15,22,23,25),]
  
names(tmp) <- c("Campus name", "Building name", "IL", "Risk", "NBS", "Cond.", "GFA")

# Convert to huxtable
ht <- hux(tmp, add_colnames = TRUE) %>%
  set_escape_contents(everywhere, everywhere, TRUE) %>%
  set_number_format(everywhere, 'GFA', fmt_pretty(digits = 3)) %>% 
  set_lr_padding(everywhere, everywhere, 0) %>%
  set_top_padding(everywhere, everywhere, 1) %>% 
  set_bottom_padding(everywhere, everywhere, 4)

# Styling
top_border(ht)[1, ]              <- brdr(1, style = "double")
bottom_border(ht)[c(1, nrow(ht)),] <- 1
bold(ht)[1, ]                    <- TRUE
valign(ht)                       <- "middle"
position(ht)                     <- "center"
align(ht)                        <- "center"
align(ht)[,c(1,2)]               <- "left"
width(ht)                        <- 1   # a bit wider for wide format
col_width(ht)                    <- c(0.3,0.3,rep(0.08,5))

caption(ht) <- "Examples of high risk/high importance assets with missing condition and NBS assessments."
caption_pos(ht) <- "bottom"   # or "bottom"

ht

```

## Descriptive Profiling
Building condition is mixed, with a substantial share in Poor or Very Poor grades. Seismic ratings also vary widely, with some buildings falling below the 34% NBS earthquake-prone threshold. High-importance (IL4) assets are the most critical for maintaining post-disaster health services, and several of these have low seismic ratings.

For IL3 and IL4 buildings, condition and %NBS often point to overlapping risk. Some facilities are both in poor condition and structurally weak, making them strong candidates for renewal. Figure 1 shows this combined view, with buildings in the bottom-right representing the most concerning cases.

```{r include=FALSE}
# Crosstab of condition grade and seismic IL
tmp <- as.data.frame.matrix(table(hosp$condition_grade, hosp$seismic_il))

# 2. Convert to data.frame and keep rownames for the leftmost column
tmp <- tibble::rownames_to_column(tmp, "Condition Grade")

ht <- hux(tmp, add_colnames = TRUE) %>%
  set_escape_contents(everywhere, everywhere, TRUE) %>%
  set_lr_padding(everywhere, everywhere, 0) %>%
  set_top_padding(everywhere, everywhere, 1) %>% 
  set_bottom_padding(everywhere, everywhere, 4)

# Styling
top_border(ht)[1, ]              <- brdr(1, style = "double")
bottom_border(ht)[c(1, nrow(ht)),] <- 1
bold(ht)[1, ]                    <- TRUE
valign(ht)                       <- "middle"
position(ht)                     <- "center"
align(ht)                        <- "center"
align(ht)[,c(1,2)]               <- "left"
width(ht)                        <- 0.6   # a bit wider for wide format
col_width(ht)                    <- c(0.4, rep(0.15,4))

caption(ht) <- "Crosstab of Importance levels and Condition grades"
caption_pos(ht) <- "bottom"   # or "bottom"

ht

```


```{r fig-il-scatter, echo=FALSE, fig.cap="Condition vs %NBS for IL3 and IL4 buildings. Dashed line marks the 34% NBS threshold.", fig.width=6.5, fig.height=3.0, fig.align='center'}
# Condition vs. NBS for high importance buildings
hosp %>%
  filter(seismic_il %in% c("IL3", "IL4"),
         !is.na(seismic_zone),
         !is.na(condition),
         !is.na(nbs)) %>%
  ggplot(aes(x = condition, y = nbs, color = seismic_zone)) +
  geom_point(alpha = 0.6) +
  geom_hline(yintercept = 0.34, linetype = "dashed", color = "red") +
  facet_wrap(~ seismic_il, nrow = 1) +
  scale_color_viridis_d(name = "Seismic zone") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    #title = "High-importance buildings: Condition vs Seismic Strength",
    x = "Condition (higher = worse)",
    y = "% NBS"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    legend.position      = "bottom",
    legend.box           = "vertical",
    #legend.box.just      = "left",
    legend.margin        = margin(t = 0, b = 0, unit = "pt"), # shrink outer margin
    legend.key.size      = unit(0.4, "lines"),                # shrink legend keys
    legend.key.height    = unit(0.4, "lines"),                # shrink vertical space
    legend.key.width     = unit(0.8, "lines"),                # shrink horizontal space
    legend.text          = element_text(size = 8),            # smaller labels
    legend.title         = element_text(size = 9),
    legend.spacing.y     = unit(0.2, "lines"),                # space between legend items
    panel.grid.minor     = element_blank(),
    plot.title           = element_text(face = "bold", hjust = 0),
    strip.text           = element_text(face = "bold"),
    panel.border         = element_rect(colour = "black", fill = NA, linewidth = 0.6)
  )

```


## Prioritisation Method – Pareto Banding
To identify high-need assets without imposing subjective weights, a non-dominated (Pareto) sorting approach was applied. This method ranks buildings by whether they are outperformed across all dimensions of need, with higher-ranked bands representing assets that are not dominated by any others.

The analysis used three variables: graded %NBS (structural strength), seismic importance level (IL), and seismic zone. Higher need was defined as lower %NBS grade, higher IL, and higher seismic zone risk. Buildings in the top Pareto bands represent those with the greatest combined structural and seismic vulnerability.

## Results

Pareto banding places 64 buildings in Bands 1–3, indicating the highest combined need (Table 2). These bands include large IL4 facilities across high seismic risk regions, many with both low seismic grades and poor condition ratings.

Figure 2 shows the distribution of IL3 and IL4 buildings by condition, %NBS, and Pareto band. Lower bands (1–3) cluster in the high-need area of the plot, combining structural weakness, high seismic importance, and high seismic risk. These assets form the core of an initial investment priority list.

```{r echo = FALSE}
# Pareto banding
dat <- hosp

# 0) add a stable row id
dat <- dat %>% mutate(.rowid = row_number())

# 1) Handle NAs
dat <- dat %>% filter(#!is.na(condition_grade),
                      !is.na(graded_nbs),
                      !is.na(seismic_il),
                      !is.na(seismic_zone)
                      #!is.na(gfa)
                      )

# This should be the initial tradeoff for the seismic assessment
# table(hosp$seismic_il, hosp$seismic_zone, hosp$graded_nbs)

# 2) build “need” columns as integers (higher = more need)
scores <- dat %>%
  transmute(
    .rowid,
    #need_condition = as.integer(condition_grade),
    need_nbs       = as.integer(graded_nbs),
    need_il        = as.numeric(seismic_il),            # 1..4 with 4 worst
    need_zone      = as.integer(seismic_zone)          # 1..3 with 3 worst
    #need_gfa       = gfa                                # numeric, larger = worse
  )

# 3) Pareto bands (negate because nds_rank minimizes)
score_mat <- as.matrix(scores %>% select(-.rowid))
ranks <- emoa::nds_rank(t(-score_mat))

# 4) attach back to the filtered data
out <- dat %>%
  select(.rowid, everything()) %>%
  left_join(
    scores %>%
      mutate(pareto_band = as.integer(ranks)),
    by = ".rowid"
  )
```



```{r echo = FALSE}
tmp <- out %>%
  group_by(pareto_band) %>%
  summarise(n = n(), .groups = "drop")

names(tmp) <- c("Pareto band", "Count")

tmp <- t(tmp)

# Convert to huxtable
ht <- hux(as.data.frame(tmp), add_colnames = FALSE, add_rownames = TRUE) %>%
  set_escape_contents(everywhere, everywhere, TRUE) %>%
  set_lr_padding(everywhere, everywhere, 2) %>%
  set_top_padding(everywhere, everywhere, 1) %>% 
  set_bottom_padding(everywhere, everywhere, 4)

# Styling
top_border(ht)[1, ]              <- brdr(1, style = "double")
bottom_border(ht)[c(1, nrow(ht)),] <- 1
bold(ht)[1, ]                    <- TRUE
valign(ht)                       <- "middle"
position(ht)                     <- "center"
align(ht)                        <- "center"
width(ht)                        <- 1   # a bit wider for wide format
col_width(ht)                    <- c(1/6,rep(1/12,10))

caption(ht) <- "Number of assets in each Pareto band"

caption_pos(ht) <- "bottom"   # or "bottom"

ht

```

- Band 1 represents the most critical combination of low seismic capacity, high building importance, and high seismic hazard zone.
- Subsequent bands reflect progressively lower combined need, though individual buildings in lower bands may still warrant investment on other grounds (e.g., condition, strategic location, service demand).

```{r echo = FALSE}
tmp <- out %>% 
  arrange(pareto_band, desc(condition_grade), desc(gfa)) %>% 
  mutate(seismic_zone = str_replace(seismic_zone, ' Zone', ''),
         seismic_zone = str_replace(seismic_zone, 'Medium', 'Med.'),
         condition_grade = str_replace(condition_grade, 'Average', 'Avg.')) %>% 
  select(pareto_band, 
         campus_name, 
         building_name, 
         seismic_il, 
         seismic_zone, 
         graded_nbs, 
         condition_grade,
         gfa) %>% .[c(1,2,6,18),]

names(tmp) <- c("Band", "Campus name", "Building name", "IL", "Risk", "NBS", "Cond.", "GFA")

# Convert to huxtable
ht <- hux(tmp, add_colnames = TRUE) %>%
  set_escape_contents(everywhere, everywhere, TRUE) %>%
  set_number_format(everywhere, 'GFA', fmt_pretty(digits = 3)) %>% 
  set_lr_padding(everywhere, everywhere, 2) %>%
  set_top_padding(everywhere, everywhere, 1) %>% 
  set_bottom_padding(everywhere, everywhere, 4)

# Styling
top_border(ht)[1, ]              <- brdr(1, style = "double")
bottom_border(ht)[c(1, nrow(ht)),] <- 1
bold(ht)[1, ]                    <- TRUE
valign(ht)                       <- "middle"
position(ht)                     <- "center"
align(ht)                        <- "center"
align(ht)[,c(2,3)]               <- "left"
width(ht)                        <- 1   # a bit wider for wide format
col_width(ht)                    <- c(0.06, 0.32, 0.32, rep(0.06, 5))

caption(ht) <- "Selected examples of high need buildings, showing seismic and condition attributes, and size (sqm)"
caption_pos(ht) <- "bottom"   # or "bottom"

ht

```


```{r, fig-il-scatter-bands, echo=FALSE, fig.cap="Condition vs %NBS for IL3 and IL4 buildings, coloured by Pareto band and shaped by Seismic Zone. Dashed line marks the 34% NBS threshold.", fig.width=6.5, fig.height=3.0, fig.align='center'}

plot_dat <- out %>%
  filter(seismic_il %in% c("IL3", "IL4")) %>%
  mutate(
    seismic_il   = factor(seismic_il, levels = c("IL3", "IL4")),
    pareto_bandF = factor(
      as.integer(pareto_band),
      levels = sort(unique(as.integer(pareto_band))),
      labels = paste("Band", sort(unique(as.integer(pareto_band))))
    ),
    pareto_bandF = fct_collapse(pareto_bandF, `Band 5+` = levels(pareto_bandF)[levels(pareto_bandF) >= "Band 5"])
  ) %>%
  drop_na(seismic_zone, condition, nbs, pareto_bandF)

ggplot(plot_dat, aes(x = condition, y = nbs,
                     color = pareto_bandF, shape = seismic_zone)) +
  geom_point(alpha = 0.65) +
  geom_hline(yintercept = 0.34, linetype = "dashed", color = "red") +
  facet_wrap(~ seismic_il, nrow = 1) +
  scale_color_viridis_d(name = "Pareto band", option = "D", end = 0.9) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_shape_discrete(name = "Seismic zone") +
  labs(
    # title = "High-importance buildings: Condition vs Seismic Strength (by Pareto band)",
    x = "Condition (higher = worse)",
    y = "% NBS"
  ) +
  theme_minimal(base_size = 11) +
  theme(
    legend.position      = "bottom",
    legend.box           = "vertical",
    #legend.box.just      = "left",
    legend.margin        = margin(t = 0, b = 0, unit = "pt"), # shrink outer margin
    legend.key.size      = unit(0.4, "lines"),                # shrink legend keys
    legend.key.height    = unit(0.4, "lines"),                # shrink vertical space
    legend.key.width     = unit(0.8, "lines"),                # shrink horizontal space
    legend.text          = element_text(size = 8),            # smaller labels
    legend.title         = element_text(size = 9),
    legend.spacing.y     = unit(0.2, "lines"),                # space between legend items
    panel.grid.minor     = element_blank(),
    plot.title           = element_text(face = "bold", hjust = 0),
    strip.text           = element_text(face = "bold"),
    panel.border         = element_rect(colour = "black", fill = NA, linewidth = 0.6)
  ) +
  guides(
    color = guide_legend(order = 1, direction = "horizontal"),
    shape = guide_legend(order = 2, direction = "horizontal")
  )


```

## Conclusions and recommendations

- Target data collection at critical IL4 buildings lacking %NBS and/or condition data to remove blind spots in risk assessment.

- Use Pareto banding to identify high-need assets for renewal, focusing on Bands 1–2 as the initial investment priority.

- Integrate improved data with broader planning inputs (e.g., service demand, location strategy) for future investment programmes.

Better data will sharpen prioritisation and ensure that limited capital is directed to assets with the greatest combined risk and service importance.
